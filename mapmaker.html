<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <title>Atlas Horizon- Map Maker</title>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/mapmaker.css">
    <style>
        /* Make the map name input and the three select boxes share equal, responsive widths
           within the controls bar. Each immediate child column will flex equally and
           the form controls will fill their container. */
        .controls-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Each direct child gets equal flex share so the input and selects match widths */
        .controls-bar > div {
            flex: 1 1 0;
            min-width: 160px; /* reasonable minimum for small viewports */
        }

        /* Ensure the input and selects take the full width of their column */
        .controls-bar input[type="text"],
        .controls-bar select {
            width: 100%;
            box-sizing: border-box;
        }
    </style>
    <link rel="icon" href="./Resources/Additional/Icons/AtlasLogo.ico" type="image/x-icon">
    <base href="https://she-fairy.github.io/atlas-horizon/">
</head>
<body>
    <script>
        if (localStorage.getItem('user') === null) {
            window.location.href = "https://discord.com/oauth2/authorize?client_id=1293658198393487420&response_type=code&redirect_uri=https%3A%2F%2Fshe-fairy.github.io%2Fatlas-horizon%2Fauth%2Fdiscord%2Fcallback.html&scope=identify";
        } 
    </script>
    <nav>
        <div class="logo">
            <img src="./Resources/Additional/Icons/AtlasLogo.png" alt="Atlas Horizon Logo" class="logo-img">
            Atlas Horizon
        </div>
        <div class="nav-links">
            <a href="./index.html">Home</a>
            <a href="./mapmaker.html" class="active">Map Maker</a>
            <a href="./map-gallery.html">Map Gallery</a>
            <a href="./my-maps.html">My Maps</a>
            <input class="avatar" type="image" id="avatar" alt="Avatar">
        </div>
    </nav>

    <div class="mapmaker-container">
        <main class="content">
            <section class="controls-bar">
                <div>
                    <p>Map Name</p>
                    <input type="text" value="Untitled Map" id="mapName" placeholder="Map Name">
                </div>
                <div class="select-inline">
                    <label for="mapSize">Map Size</label>
                    <select id="mapSize">
                        <option value="regular">Regular</option>
                        <option value="showdown">Showdown</option>
                        <option style="color:blueviolet" value="arena">Brawl Arena</option>
                        <option value="siege">Siege</option>
                        <option value="volley">Volley Brawl</option>
                        <option value="basket">Basket Brawl</option>
                    </select>
                </div>
                <div class="select-inline">
                    <label for="gamemode">Gamemode</label>
                    <select id="gamemode">
                        <option style="color:#7ab6ed" value="Gem_Grab">Gem Grab</option>
                        <option style="color:#7ab6ed" value="Showdown">Showdown</option>
                        <option style="color:#7ab6ed" value="Heist">Heist</option>
                        <option style="color:#7ab6ed" value="Bounty">Bounty</option>
                        <option style="color:#7ab6ed" value="Brawl_Ball">Brawl Ball</option>
                        <option value="Siege">Siege</option>
                        <option value="Snowtel_Thieves">Trophy Thieves</option>
                        <option style="color:#7ab6ed" value="Hot_Zone">Hot Zone</option>
                        <option style="color:#7ab6ed" value="Knockout">Knockout</option>
                        <option style="color:#7ab6ed" value="Basket_Brawl">Basket Brawl</option>
                        <option value="Hold_The_Trophy">Hold The Trophy</option>
                        <option style="color:#7ab6ed" value="Volley_Brawl">Volley Brawl</option>
                        <option style="color:#7ab6ed" value="Duels">Duels</option>
                        <option style="color:#7ab6ed" value="Wipeout">Wipeout</option>
                        <option value="Bot_Drop">Bot Drop</option>
                        <option value="Hunters">Hunters</option>
                        <option value="Trophy_Escape">Trophy Escape</option>
                        <option value="Drumroll">Drumroll</option>
                        <option value="Paint_Brawl">Paint Brawl</option> 
                        <option value="Cleaning_Duty">Cleaning Duty</option> 
                        <option value="Soul Collector">Soul Collector</option> 
                        <option style="color:#7ab6ed" value="Hockey">Hockey Brawl</option>
                        <option style="color:#7ab6ed" value="Token_Run">Token Run</option>
                        <option value="Samurai_Smash">Samurai Smash</option>
                        <option style="color:#7ab6ed" value="Brawl_Arena">Brawl Arena</option>
                        <option style="color:#7ab6ed" value="Dodgebrawl">Dodgebrawl</option>
                        <option style="color:#e6c057" value="Godzilla_City_Smash">Godzilla City Smash</option>
                    </select>
                </div>
                <div class="select-inline">
                    <label for="environment">Environment</label>
                    <select id="environment">
                        <option style="color:#7ab6ed" value="Desert">Desert</option>
                        <option style="color:#7ab6ed" value="Wasteland">Wasteland</option>
                        <option style="color:#7ab6ed" value="Mine">Mine</option>
                        <option value="Oasis">Oasis</option>
                        <option style="color:#7ab6ed" value="Grassy_Field">Grassy Field</option>
                        <option value="Holiday">Holiday</option>
                        <option value="City">City</option>
                        <option value="Retropolis">Retropolis</option>
                        <option value="Mortuary">Mortuary</option>
                        <option value="Pirate_Ship">Pirate Ship</option>
                        <option style="color:#7ab6ed" value="Arcade">Arcade</option>
                        <option style="color:#7ab6ed" value="Stadium">Stadium</option>
                        <option style="color:#7ab6ed" value="Bazaar">Bazaar</option>
                        <option value="Super_City">Super City</option>
                        <option value="Gift_Shop">Gift Shop</option>
                        <option value="Bandstand">Bandstand</option> 
                        <option value="Snowtel">Snowtel</option>
                        <option value="Scrapyard">Scrapyard</option>
                        <option value="Starr_Force">Starr Force</option>
                        <option value="Wild_West">Wild West</option>
                        <option value="Water_Park">Water Park</option>
                        <option value="Castle_Courtyard">Castle Courtyard</option>
                        <option value="Brawlywood">Brawlywood</option> 
                        <option value="Fighting_Game">Fighting Game</option>
                        <option value="Biodome">Biodome</option>
                        <option style="color:#7ab6ed" value="Stunt_Show">Stunt Show</option>
                        <option value="Deep_Sea">Deep Sea</option>
                        <option value="Robot_Factory">Robot Factory</option>
                        <option value="Ghost_Station">Ghost Station</option>
                        <option value="Candyland">Candyland</option>
                        <option style="color:#7ab6ed" value="The_Hub">The Hub</option>
                        <option style="color:#7ab6ed" value="Rooftop">Rooftop</option>
                        <option value="Rumble_Jungle">Rumble Jungle</option> 
                        <option style="color:#7ab6ed" value="Enchanted_Woods">Enchanted Woods</option>
                        <option value="Ranger_Ranch">Ranger Ranch</option>
                        <option value="Circus">Bizarre Circus</option> 
                        <option style="color:#7ab6ed" value="Coin_Factory">Coin Factory (Megapig)</option>
                        <option value="Starr_Toon">Starr Toon</option>
                        <option value="Ice_Island">Ice Island</option>
                        <option value="Swamp_of_Love">Swamp of Love</option>
                        <option value="Medieval_Manor">MadEvil Manor</option>
                        <option value="Super_City_2">Kaiju Park</option> 
                        <option value="Spongebob">Bikini Bottom</option>
                        <option value="Oddities_Shop">Oddities Shop</option>
                        <option value="Skating_Bowl">Skatepark</option>
                        <option style="color:#7ab6ed" value="Hockey">Ice Rink</option>
                        <option value="Escape_Room">Pyramid Quest</option>
                        <option style="color:#7ab6ed" value="Katana_Kingdom">Katana Kingdom</option>
                        <option style="color:#7ab6ed" value="Tropical_Island">Tropical Island</option>
                        <option style="color:#7ab6ed" value="Subway_Surfers">Subway Surfers</option>
                    </select>
                </div>
            </section>
            <div class="center-panel">
                <div class="left-panel">
                    <section class="tiles-section">
                        <div class="tiles-grid">
                            <h4 id="tilesTitle">Tiles</h4>
                            <div id="tileSelector"></div>
                        </div>
                    </section>
                </div>
                <section class="map-wrapper">
                    <!-- Zoom controls moved inside .map-editor for fixed positioning -->
                    <div class="map-editor">
                        <div class="map-container">
                            <canvas draggable="false" id="mapCanvas"></canvas>
                        </div>
                        <div id="zoomControls" class="zoom-controls">
                            <button id="zoomInBtn" class="zoom-btn" title="Zoom In (Ctrl++)">
                                <img src="./Resources/Additional/Icons/GlassPlus.png" alt="Zoom In">
                            </button>
                            <button id="zoomOutBtn" class="zoom-btn" title="Zoom Out (Ctrl+-)">
                                <img src="./Resources/Additional/Icons/GlassMinus.png" alt="Zoom Out">
                            </button>
                        </div>
                    </div> 
                </section>
                <div class="right-panel">
                    <section class="selections-section">
                        <div class="selections-container">
                            <h3>Selection Options</h3>
                                <label class="select-btn" title="Single (1)">
                                    <input type="radio" name="selectionMode" id="singleBtn" value="single" checked>
                                    <mob>Single</mob>
                                    <img src="./Resources/Additional/Icons/Single.png" alt="Single">
                                </label>
                                <label class="select-btn" title="Line (2)">
                                    <input type="radio" name="selectionMode" id="lineBtn" value="line">
                                    <mob>Line</mob>
                                    <img src="./Resources/Additional/Icons/Line.png" alt="Line">
                                </label>
                                <label class="select-btn" title="Rectangle (3)">
                                    <input type="radio" name="selectionMode" id="rectangleBtn" value="rectangle">
                                    <mob>Rectangle</mob>
                                    <img src="./Resources/Additional/Icons/Rectangle.png" alt="Rectangle">
                                </label>
                                <label class="select-btn" title="Fill (4)">
                                    <input type="radio" name="selectionMode" id="fillBtn" value="fill">
                                    <mob>Fill</mob>
                                    <img src="./Resources/Additional/Icons/Bucket.png" alt="Fill">
                                </label>
                                <label class="select-btn" title="Select (5)">
                                    <input type="radio" name="selectionMode" id="selectBtn" value="select">
                                    <mob>Select</mob>
                                    <img src="./Resources/Additional/Icons/Select.png" alt="Select">
                                </label>
                            </div>
                    </section>

                    <section class="toolbar toolbar-horizontal">
                        <pc><h5>Mirroring</h5></pc>
                        <div class="toolbar-section">
                            <label class="mirror-btn"><input type="checkbox" id="mirrorDiagonal">Diagonal</label>
                            <label class="mirror-btn"><input type="checkbox" id="mirrorVertical">Vertical</label>
                            <label class="mirror-btn"><input type="checkbox" id="mirrorHorizontal">Horizontal</label>
                        </div>
                        <label class="long-btn"><input type="checkbox" id="correctMirroringBtn">Mirror Matching Elements</label>

                        <div class="toolbar-divider"></div>

                        <pc><h5>Tools</h5></pc>
                        <div class="toolbar-section">
                            <label class="icon-btn"><input type="checkbox" id="eraseBtn"><img src="./Resources/Additional/Icons/Erase.png" alt="Erase"></label>
                            <button id="undoBtn" class="icon-btn"><img src="./Resources/Additional/Icons/Undo.png" alt="Undo"></button>
                            <button id="redoBtn" class="icon-btn"><img src="./Resources/Additional/Icons/Redo.png" alt="Redo"></button>
                            <label class="icon-btn"><input type="checkbox" id="replaceBtn"><img src="./Resources/Additional/Icons/Replace.png" alt="Replace"></label>
                            <label class="icon-btn"><input type="checkbox" id="errorsBtn"><img src="./Resources/Additional/Icons/Issues.png" alt="Errors"></label>
                            <label class="icon-btn"><input type="checkbox" id="guidesBtn"><img src="./Resources/Additional/Icons/Grid.png" alt="Guides"></label>
                        </div>

                        <div class="toolbar-divider"></div>

                        <pc><h5>Zoom</h5></pc>
                        <div class="toolbar-section zoom-section">
                            <button id="zoomInBtnBottom" class="zoom-btn"><img src="./Resources/Additional/Icons/GlassPlus.png" alt="Zoom In"></button>
                            <button id="zoomOutBtnBottom" class="zoom-btn"><img src="./Resources/Additional/Icons/GlassMinus.png" alt="Zoom Out"></button>
                            <label class="long-btn"><input type="checkbox" id="hideZoomBtn">Hide Zoom Controls</label>
                        </div>

                        <div id="lastDivider" style="display: none;" class="toolbar-divider"></div>

                        <div class="toolbar-section" id="selectedAreaToolsDiv" style="display:none;">
                            <pc><mob><h6 style="color:var(--primary-color)">Area Select Tools:</h6></mob></pc>
                            <button id="rotateBtn" class="icon-btn"><img src="./Resources/Additional/Icons/Rotate.png" alt="Rotate"></button>
                        </div>
                    </section>
                </div>
            </div>

            <section class="below-map">
                <div class="save-export-buttons">
                    <button id="saveBtn" class="text-btn" title="Save Map (Ctrl+S)">Save Map</button>
                    <button id="exportBtn" class="text-btn" title="Export as PNG (Ctrl+E)">Download Map</button>
                    <button id="clearBtn" class="text-btn" title="Clear Map (Ctrl+Del)">Clear Map</button>
                </div>
                <div class="map-link">
                    <div class="link-container">
                        <span>Link:</span>
                        <a id="mapLink" style="display:inline-block; word-wrap:break-word; overflow-wrap:break-word; white-space:normal; max-width:100%; font-family: Arial, Helvetica, sans-serif; font-weight: 400; color: var(--primary-color);">https://she-fairy.github.io/atlas-horizon/map.html</a>
                        <button id="copyLinkBtn" class="copy-btn" title="Copy link to clipboard">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>
    <div class="tooltip-floating disclaimer-tooltip">
        ?
        <div class="tooltip-text">
            This site is not affiliated with or endorsed by Supercell. Brawl Stars and all related assets belong to Supercell.
        </div>
    </div>
    <div class="tooltip-floating shortcuts-tooltip">
        <img src="./Resources/Additional/Icons/Key.png" alt="Keyboard Shortcuts">
        <div class="tooltip-text shortcuts-text">
            <h4>Keyboard Shortcuts</h4>
            <ul>
                <li><kbd>Ctrl/Shift</kbd> + <kbd>1</kbd> Diagonal</li>
                <li><kbd>Ctrl/Shift</kbd> + <kbd>2</kbd> Vertical</li>
                <li><kbd>Ctrl/Shift</kbd> + <kbd>3</kbd> Horizontal</li>
                <li><kbd>1</kbd> Single Selection</li>
                <li><kbd>2</kbd> Line Selection</li>
                <li><kbd>3</kbd> Rectangle Selection</li>
                <li><kbd>4</kbd> Fill Selection</li>
                <li><kbd>R</kbd> Toggle Replace Mode</li>
                <li><kbd>E</kbd> Toggle Erase Mode</li>
                <li><kbd>M</kbd> Toggle Mirroring</li>
                <li><kbd>N</kbd> Toggle Blue to Red Mirroring</li>
                <li><kbd>Q</kbd> Toggle Error Check</li>
                <li><kbd>Ctrl</kbd> + <kbd>Z</kbd> Undo</li>
                <li><kbd>Ctrl</kbd> + <kbd>Y</kbd> Redo</li>
                <li><kbd>Ctrl</kbd> + <kbd>Del</kbd> Clear Map</li>
            </ul>
        </div>
    </div>

    <script>
        const avatar = document.getElementById('avatar');
        avatar.src = localStorage.getItem('avatar');
        avatar.addEventListener('click', () => {
            if (confirm('Do you want to log out of this account?')){
                localStorage.clear();
                window.location.href = './index.html';
            }
        })

        // Side panel toggle for tools
        const panelToggle = document.getElementById('panelToggle');
        const sidePanel = document.querySelector('.side-panel');

        function togglePanel(){
            if (sidePanel) {
                const isHidden = sidePanel.getAttribute('aria-hidden') === 'true';
                sidePanel.setAttribute('aria-hidden', !isHidden);
                panelToggle.setAttribute('aria-label', isHidden ? 'Close tools' : 'Open tools');
            }
        }

        if (panelToggle) panelToggle.addEventListener('click', togglePanel);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && sidePanel && sidePanel.getAttribute('aria-hidden') === 'false') {
                togglePanel();
            }
        });

        // Copy link functionality
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const mapLink = document.getElementById('mapLink');
        
        if (copyLinkBtn && mapLink) {
            copyLinkBtn.addEventListener('click', async () => {
                try {
                    const linkText = mapLink.textContent || mapLink.href;
                    await navigator.clipboard.writeText(linkText);
                    // Visual feedback
                    const originalTitle = copyLinkBtn.title;
                    copyLinkBtn.title = 'Copied!';
                    copyLinkBtn.style.background = 'var(--primary-color)';
                    copyLinkBtn.style.color = 'white';
                    setTimeout(() => {
                        copyLinkBtn.title = originalTitle;
                        copyLinkBtn.style.background = '';
                        copyLinkBtn.style.color = '';
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy link:', err);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = mapLink.textContent || mapLink.href;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    // Visual feedback for fallback
                    const originalTitle = copyLinkBtn.title;
                    copyLinkBtn.title = 'Copied!';
                    copyLinkBtn.style.background = 'var(--primary-color)';
                    copyLinkBtn.style.color = 'white';
                    setTimeout(() => {
                        copyLinkBtn.title = originalTitle;
                        copyLinkBtn.style.background = '';
                        copyLinkBtn.style.color = '';
                    }, 2000);
                }
            });
        }

        // --- Zoom Controls Positioning ---
        function positionZoomControls() {
            const mapEditor = document.querySelector('.map-editor');
            const zoomControls = document.getElementById('zoomControls');
            if (!mapEditor || !zoomControls) return;

            const rect = mapEditor.getBoundingClientRect();
            // Offset controls 2rem to the right and 2rem to the bottom from the top-left of the map editor
            const rem = parseFloat(getComputedStyle(document.documentElement).fontSize) || 16;
            zoomControls.style.top = `${rect.top + 2 * rem}px`;
            zoomControls.style.left = `${rect.left + 2 * rem}px`;
        }

        // Continuously update position every animation frame
        function animateZoomControls() {
            positionZoomControls();
            requestAnimationFrame(animateZoomControls);
        }

        window.addEventListener('DOMContentLoaded', () => {
            animateZoomControls();
        });
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script src="./js/firebase-service.js"></script>
    <script type="module" src="./js/mapmaker.js"></script>
</body>
</html>
