<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Discord OAuth Callback</title>
</head>
<body>
  <h1>Wait a second bishling...</h1>

  <!-- Firebase libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="/js/firebase-service.js"></script>

  <script>
    async function handleDiscordCallback() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");

      if (!code) {
        document.body.innerHTML = "<p>Missing code in URL.</p>";
        return;
      }

      const redirectUri = "http://127.0.0.1:5500/auth/discord/callback.html";

      try {
        const res = await fetch("https://discord-oauth-worker.shefairies.workers.dev", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ code, redirect_uri: redirectUri })
        });

        const { tokenData, userData } = await res.json();

        if (!userData) {
          document.body.innerHTML = "<p>Login failed. Try again.</p>";
          return;
        }

        sessionStorage.setItem("user", userData.username);
        sessionStorage.setItem("avatar", `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png`);

        const snapshot = await Firebase.readDataOnce("users/" + userData.username);

        if (snapshot.exists && snapshot.exists()) {
          console.log("User already exists");
        } else {
          await Firebase.writeData("users/" + userData.username, {
            id: userData.id,
            username: userData.username,
            discriminator: userData.discriminator,
            avatar: userData.avatar
          });
          console.log("User created successfully");
        }

        // âœ… Safe to redirect after Firebase operations complete
        window.location.href = "../../../index.html";

      } catch (err) {
        console.error("OAuth Error", err);
        document.body.innerHTML = "<p>Error occurred. See console.</p>";
      }
    }

    handleDiscordCallback();
  </script>
</body>
</html>
